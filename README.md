# Meeting Agenda Agent v2.0

🚀 **Now with LangGraph-powered iterative planning!**

Local agenda planning on top of the Spine SQLite store. The agent retrieves recent org facts, proposes meeting agendas, and persists proposals as `facts` rows so reviewers can update the status lifecycle (`draft → proposed → validated → published → rejected`).

## ✨ What's New in v2.0

- **LangGraph Workflow**: 8-step iterative planning with quality review and auto-refinement
- **LLM-Powered Intent Detection**: Automatically classifies meeting type (decision_making, problem_solving, planning, alignment, status_update, kickoff)
- **Multi-Strategy Retrieval**: Combines workstreams, semantic search, and urgent facts with LLM ranking
- **Quality Gates**: Self-reviews agendas and refines up to 2 times if quality score < 0.7
- **Full Observability**: Metadata includes step timings, quality scores, retrieval stats, and refinement counts

📖 **Documentation:**
- **[Setup Guide](LANGGRAPH_SETUP.md)** - Quick start with LangGraph v2.0
- **[Architecture](ARCHITECTURE.md)** - Code structure and migration plan
- **Legacy planner** still available in `agent/legacy/` for fallback

## Highlights
- SQLite Spine schema (facts, evidence, entities, transcripts) with optional FTS5.
- Retrieval helpers to pull recent or subject-focused facts with hydrated evidence/entities.
- Planner writes idempotent agenda proposals (`fact_type='meeting_metadata'`, `payload.kind='agenda_proposal'`).
- CLI + HTTP API for proposing agendas, listing proposals, searching facts, and updating statuses.
- Seed/demo scripts to populate a local DB for quick testing.

## Requirements
- Python 3.11+
- No external services needed; SQLite is bundled.
- **OpenAI API key** (GPT-5, GPT-4o, or compatible models) - shared with parsing-agent
- Optional: FastAPI + Uvicorn for the HTTP API (install via `pip install -r requirements.txt`).

## Quick Start

### Traditional (Legacy Planner)
```bash
python -m agent.cli init-db --org org_demo
python -m agent.cli seed minimal
python -m agent.cli agenda propose --org org_demo --subject "Quarterly sync"
python -m agent.cli agenda list --org org_demo
```

### LangGraph v2.0 (Recommended)
```bash
# Install dependencies
pip install -r requirements.txt

# Set environment variables (uses your existing OpenAI setup)
export OPENAI_API_KEY="sk-..."  # Already configured for parsing-agent
export USE_LANGGRAPH_AGENDA="true"  # Enable v2.0 planner

# Start HTTP API
python -m uvicorn agent.api:app --host 127.0.0.1 --port 8000

# Test via API
curl -X POST http://localhost:8000/agenda/plan-nl \
  -H "Content-Type: application/json" \
  -d '{"text": "próxima reunião com a BYD sobre integração", "org": "org_demo"}'
```

**Check response metadata to confirm v2.0:**
```json
{
  "metadata": {
    "version": "2.0",
    "generator": "langgraph",
    "quality_score": 0.85,
    "intent": "decision_making"
  }
}
```

## Running locally
```bash
python -m agent.cli init-db --org org_demo
python -m agent.cli seed minimal
python -m agent.cli agenda propose --org org_demo --subject "Quarterly sync"
python -m agent.cli agenda list --org org_demo
```

Want an end-to-end demo? Run `python -m scripts.demo_flow` to seed data, propose an agenda, and show the latest proposals.

## CLI reference
- `init-db` – create the SQLite schema and ensure an org exists.
- `org add <org_id> [name]` – insert/update an org.
- `agenda propose [...]` – generate + persist an agenda.
- `agenda list [--limit N]` – show recent agenda proposals.
- `facts search [--q text] [--types a,b]` – FTS-backed search across facts/evidence.
- `facts set-status <fact_id> <status>` – update reviewer status.
- `seed minimal` – load demo data via the helper script.

Example:
```bash
python -m agent.cli facts search --org org_demo --q "pricing" --types decision,action_item
```

## Loading parsing output
To load a full Spine bundle generated by the parsing agent:
```bash
python -m scripts.ingest_bundle ../parsing-agent/out/spine_bundle.json --status draft --org-name "My Org"
```
This copies the bundle facts, evidence, participants, and transcript metadata into the local SQLite Spine DB.

Alternatively, you can use the convenience script that will also create/upgrade the DB schema if needed and populate new evidence fields like `utterance_ids`, `char_span`, `card_id`, and `who_said_id`:
```bash
python -m scripts.store_items ../parsing-agent/out/spine_bundle.json --status draft --org-name "My Org"
```
The database path defaults to `./spine_dev.sqlite3` (override with env `SPINE_DB_PATH`).

## Inspecting the DB
Quickly inspect tables, orgs, fact counts, and sample rows:

```powershell
# Show overall stats
python -m scripts.inspect_db

# Filter by org and limit samples
python -m scripts.inspect_db --org byd --limit 10
```
Notes:
- The script resolves the DB path in this order: env `SPINE_DB_PATH` → `agent.config.spine_db_path()` → `meeting-agent/spine_dev.sqlite3`.
- If you see "DB file not found", check your current working directory and `SPINE_DB_PATH`.
## HTTP API (optional)
Run `python -m agent.api` once FastAPI/Uvicorn are installed. Key endpoints:
- `POST /agenda/propose` – body `{ "org": "org_demo", "subject": "Q4 kickoff" }`
- `GET /agenda/proposals?org=org_demo&limit=10`
- `GET /facts/search?org=org_demo&q=pricing&types=decision,action_item`
- `POST /facts/{fact_id}/status` – body `{ "status": "validated" }`

### Running with Uvicorn (no Docker)

Install dependencies (if you only installed the library pieces):

```bash
pip install fastapi uvicorn
```

Initialize (idempotent) then start the ASGI app:

```bash
python -m agent.cli init-db --org org_demo
uvicorn agent.api:app --host 0.0.0.0 --port 8000
```

During development you can enable autoreload:

```bash
uvicorn agent.api:app --reload --port 8000
```

Quick smoke:

```bash
curl -s http://localhost:8000/health
curl -s -X POST http://localhost:8000/agenda/plan-nl -H "Content-Type: application/json" \
	-d '{"text":"próxima reunião sobre integrações, 30 min","format":"nl"}' | jq .text
```

### Natural language agenda planning

New capabilities:

- `POST /agenda/propose` now accepts `prompt` (free text) and `format=nl` to return a rendered textual agenda instead of JSON.
- `POST /agenda/plan-nl` parses a free‐text prompt without persisting (preview only). Accepts `format=nl`.
- `GET /health` returns `{ "ok": true }` for liveness checks.

Examples (JSON bodies):

```
POST /agenda/plan-nl
{ "text": "faça a pauta da próxima reunião com a BYD sobre integração de API, 60 min", "format": "nl" }

POST /agenda/propose
{ "org": "byd", "prompt": "próxima reunião com a BYD sobre custos logísticos, 45 min", "format": "nl" }
```

Duration extraction supports patterns like: `60 min`, `1h30`, `90m`, `meia hora`, `uma hora e meia`, `half an hour`, `one hour and a half`.

If a subject isn’t detected, the planner falls back to a forward-looking (next-only) agenda; if a concrete subject is parsed (e.g. after `sobre / about`), it uses the subject-centered path automatically.

### Text agenda output hygiene
The textual agenda renderer removes redundant prefixes (e.g. `Decidir:` repeated), trims trailing conjunctions, and normalizes Portuguese risk/decision bullets.

## Docker

A minimal container image is provided via the root `Dockerfile` (FastAPI server on port 8000):

Build:

```bash
docker build -t meeting-agent:latest .
```

Run:

```bash
docker run -p 8000:8000 -e DEFAULT_ORG_ID=byd meeting-agent:latest
```

Then call (adjust host if remote):

```bash
curl -s http://localhost:8000/health
curl -s -X POST http://localhost:8000/agenda/plan-nl -H "Content-Type: application/json" \
	-d '{"text":"próxima reunião com a BYD sobre integrações, 45 min","format":"nl"}'
```

Environment variables:
- `SPINE_DB_PATH` – SQLite path (defaults to `/app/meeting-agent/spine_dev.sqlite3` in container)
- `DEFAULT_ORG_ID` – org id created at container start (default `org_demo`)

## Data notes
- Database path defaults to `./spine_dev.sqlite3` (override with `SPINE_DB_PATH`).
- FTS can be disabled via `SPINE_FTS_ENABLED=0`.
- Default org id is `org_demo` (override with `DEFAULT_ORG_ID`).
- Agenda proposals are idempotent using a hash of org, meeting, subject, and agenda JSON.

## Development checklist
- `python -m agent.cli init-db`
- `python -m agent.cli seed minimal`
- `python -m agent.cli facts search --org org_demo --q "pricing"`
- `python -m agent.cli agenda propose --org org_demo --subject "Q4 kickoff"`
- `python -m agent.cli facts set-status <fact_id> validated`

Happy planning!


